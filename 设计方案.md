## 1. 设计目标与约束

- **不破坏现有可靠模式**：在引入性能模式后，`NonceComponent` 对外接口、业务语义与基于 PostgreSQL 的 `NonceService` 逻辑保持不变，业务方零改动。
- **引入性能模式**：利用 Redis 原子操作、高吞吐及内存数据结构缓解热点 submitter 的数据库写压力，提升 TPS。
- **安全回退与自动降级**：Redis 故障、刷盘失败或状态冲突时自动降级到可靠模式；所有状态机校验依旧生效，避免重复或跳号。
- **最终一致性**：Postgres 始终是真相源，Redis 仅做加速缓存；异步刷盘、重试与对账流程保证最终一致。

## 2. 总体架构

系统沿用「门面层 → 服务层 → 引擎层」三层结构，核心组件如下：

```
          ┌───────────────────────┐
          │        NonceComponent │
          │      （门面层，不变）     │
          └───────────────────────┘
                     │
                     ▼
          ┌───────────────────────┐
          │    NonceEngineManager │◄── 配置 & 健康检查决定路由
          └───────────────────────┘
            │             │
  ┌─────────┴──────┐    ┌──┴────────────┐
  │ ReliableNonceEngine│  │PerformanceNonceEngine│
  │   (Postgres 主导)  │  │     (Redis 主导)     │
  └─────────┬────────┘  └──────┬───────────┘
            │                 │
  ┌─────────▼────────┐ ┌──────▼───────────────────┐
  │ PostgresNonceRepo │ │RedisNonceCounter/Recyclable│
  │    (DB 真相源)    │ │NonceFlushWorker          │
  └───────────────────┘ └──────────────────────────┘
```

### 2.1 NonceComponent（门面层）
- 提供 allocate、markUsed、markRecyclable 等接口。  
### 2.2 NonceEngineManager
- 依据配置、Redis 健康度、DUAL_WRITE 状态动态选择引擎。  
- 维护模式切换状态机（`RELIABLE`、`DUAL_WRITE`、`PERFORMANCE`）。

### 2.3 NonceAllocationEngine（策略接口）
- 定义 `allocate() / markUsed() / markRecyclable()` 等统一方法。  
- `ReliableNonceEngine`：复用现有 `NonceService`，所有操作走 Postgres 事务。  
- `PerformanceNonceEngine`：Redis 主导，异步刷盘，保证最终一致。

### 2.4 Redis 层组件
- **RedisNonceCounter**：按 submitter 维护自增计数器，切换前从 Postgres `nextLocalNonce` 初始化。  
- **RecyclablePool**：Set/ZSet 存储可复用 nonce，支持最小值弹出。  
- **AllocationCache**：记录 nonce -> 状态，供刷盘、重放使用。

### 2.5 NonceFlushWorker
- 消费待刷盘队列，按 submitter 分组顺序写回 Postgres。  
- 具备批处理、失败重试、告警、手动补偿能力。  
- 负责异常场景下触发降级并驱动 Redis 视图修复。

## 3. 模式设计

### 3.1 可靠模式（Reliable Mode）
1. 依旧使用 Redis 分布式锁 + Postgres 行锁串行化热 submitter。  
2. 单事务内更新 `SubmitterNonceState` 与状态机，保证无跳号/重复。  
3. 故障时作为兜底模式，切换代价低。  
4. 性能瓶颈：高并发下行锁竞争，DB TPS 限制。

### 3.2 性能模式（Performance Mode）

#### 核心数据结构
- **计数器**：`INCR` 生成新 nonce，保证单调递增。  
- **可复用池**：优先回收再分配，减少跳号。  
- **分配缓存 + Flush 队列**：记录状态并驱动异步写库。

#### 分配流程
1. 获取 submitter 级 Redis 锁（或 Lua 脚本原子执行）。  
2. 若可复用池非空，弹出最小 nonce 并标记 `RESERVED`。  
3. 否则对计数器 `INCR`，生成新 nonce，记录到缓存。  
4. 将事件写入 flush 队列，立即返回给业务。  

#### 标记流程
- `markUsed`/`markRecyclable` 在 Redis 中更新状态，同时投递刷盘事件。  
- 回收流：`RESERVED` 若链上未成功消耗则转 `RECYCLABLE` 并回流至池；链上确认成功的 `RESERVED` 则转 `USED` 并终止回收链路。（为了防止数据不断膨胀，被标记为USED的数据可以认为是这个nonce的生命周期结束了，可以在完成Postgres持久化之后清除防止长期占用内存而不使用）

#### 异步刷盘
- `NonceFlushWorker` 批量读取队列，按提交者顺序写 DB，并推进 `nextLocalNonce`。  
- 每批落地后删除缓存，成功 ACK；失败则重试并打告警。  
- 可配置同步刷盘阈值：若延迟超过 SLA，临时同步写以降低不一致窗口。

#### DUAL_WRITE 预热
- 切换前进入 DUAL_WRITE：可靠模式仍生效，同时镜像写 Redis，直到 Redis 状态追齐 DB。  
- 完成对账（计数器 ≥ `nextLocalNonce` 且缓存一致）后才允许流量切至性能模式。  
- 回退时仍保留 Redis 改动，便于再次切换。
- 反向切回可靠模式时需进入 `DRAIN_AND_SYNC` 阶段：先暂停新流量进入性能模式，只允许刷盘 worker 将 Redis 待写事件彻底落地 Postgres，或者临时同步写直至队列清空。只有在 DB 状态追齐 Redis、`nextLocalNonce` 连续且可复用池已刷新的情况下，才能安全地完全关闭性能模式，否则可靠模式会读到落后的真相源导致重复分配或跳号。（可靠模式直接读 DB，如果刷盘队列里仍有“只在 Redis 中存在”的 RESERVED/USED 记录，立即切换会让 DB 看不到这些分配，导致重复 nonce 或跳号。所以要保证Postgres 中也是最新，然后再关闭性能模式。如果场景不允许等待（例如 Redis 故障已导致写失败），也要先尽可能重放/补刷 Redis 中仍可访问的数据，再依靠 Postgres 唯一约束与链上状态重建剩余 nonce。）

## 4. 模式切换与降级流程

### 4.1 切换至性能模式
1. **前置检查**：Redis 主从健康、刷盘队列可用、监控告警正常；所有 submitter 的 `nextLocalNonce` 被加载到引擎管理器缓存。  
2. **进入 DUAL_WRITE**：业务仍走可靠模式，但在事务成功后镜像写 Redis（计数器、缓存、可复用池），并记录 DUAL_WRITE 延迟。  
3. **对账校验**：定时比对 Redis 视图与 Postgres；确认计数器 ≥ `nextLocalNonce` 且无落后缓存后，整个引擎即可切至性能模式。  
4. **全量切换**：EngineManager 将所有流量切到 `PerformanceNonceEngine`，可靠模式作为兜底路径保留但不再承载正常分配。  
5. **回写保障**：即使在性能模式，刷盘 worker 仍需保证 Postgres 延迟在 SLA 内，以便随时降级。

### 4.2 自动降级流程
触发条件：Redis 大面积故障、刷盘重试超阈值、对账检出冲突、性能指标异常等。

1. **告警 + 健康判定**：链路监控触发告警后，EngineManager 自动标记性能模式为 `DEGRADED`。  
2. **停止新分配**：立即阻止新请求进入 `PerformanceNonceEngine`，改由可靠模式接管（可短暂拒绝服务以等待锁释放）。  
3. **刷盘清尾**：如果 Redis 仍可读，则进入 `DRAIN_AND_SYNC`，将剩余缓存事件刷回 Postgres；若 Redis 不可用，则依赖链上状态与 Postgres 唯一约束重建。  
4. **状态校准**：对账任务确认 Postgres 已连续、无缺口后，将模式切换到 `RELIABLE`。  
5. **恢复观察**：持续观察一段时间，若 Redis 恢复且指标稳定，再按 4.1 的流程重新进入 DUAL_WRITE。

### 4.3 手动回退 / 运维操作
- **人工开关**：配置中心 or 控制台提供显式按钮，可强制进入 DUAL_WRITE、DRAIN 或 RELIABLE 状态。  
- **回放工具**：提供脚本读取 Redis 中的未刷盘记录，将其批量补写 Postgres。  
- **状态重建**：若 Redis 数据丢失，可通过扫描 Postgres `NonceAllocation` 和 `SubmitterNonceState` 重建计数器、可复用池，之后再开启 DUAL_WRITE。

### 4.4 重新进入性能模式
1. Redis 恢复后，先以可靠模式运行，同时启动 DUAL_WRITE 重新预热。  
2. 对账成功且刷盘延迟恢复后，整体切回性能模式。  
3. 历史指标用于评估 Redis 承载能力，必要时按提交者做拆分或限流。
