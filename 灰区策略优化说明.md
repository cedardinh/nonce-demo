# ç°åŒºç­–ç•¥ä¼˜åŒ–è¯´æ˜

> é’ˆå¯¹ã€Šé¡¹ç›®æ¼”è¿›è®¡åˆ’.mdã€‹ä»»åŠ¡ 5.2 çš„ç»†åŒ–å‡çº§

---

## ğŸ¯ ä¼˜åŒ–èƒŒæ™¯

### åŸæ–¹æ¡ˆçš„é—®é¢˜

**åŸè®¾è®¡ï¼ˆV1ï¼‰**ï¼š
```
if (KnownTransactionException) {
    if (æœ¬åœ°æœ‰ hash) {
        return æˆåŠŸï¼ˆå¹‚ç­‰ï¼‰
    } else {
        å°è¯•é‡ç®— hash
        if (æˆåŠŸ) return æˆåŠŸ
        else throw å¼‚å¸¸
    }
}
```

**æ ¸å¿ƒç¼ºé™·**ï¼š
1. âŒ æ²¡æœ‰ä¸“é—¨çš„"ç°åŒº"çŠ¶æ€ï¼Œåªèƒ½ throw å¼‚å¸¸
2. âŒ ç°åŒºæƒ…å†µä¸‹ç›´æ¥å¤±è´¥ï¼Œæ— æ³•åç»­è¡¥å¿
3. âŒ å¼‚å¸¸ç±»å‹ä¸å¤Ÿç»†åŒ–ï¼Œæ— æ³•åŒºåˆ†"ç¡®å®šå¤±è´¥"å’Œ"çŠ¶æ€æœªçŸ¥"
4. âŒ ç¼ºå°‘åå°è¡¥å¿æœºåˆ¶

---

## âœ¨ ä¼˜åŒ–åçš„æ–¹æ¡ˆ

### 1. å¼•å…¥ UNKNOWN_SUBMIT_RESULT çŠ¶æ€

```java
public enum TransactionState {
    PENDING,                // å¾…æäº¤
    TRACKING,               // å·²æäº¤ï¼Œè·Ÿè¸ªä¸­
    CONFIRMED,              // å·²ç»ˆå±€ç¡®è®¤
    FAILED,                 // æ˜ç¡®å¤±è´¥
    UNKNOWN_SUBMIT_RESULT   // â­ æ–°å¢ï¼šæäº¤ç»“æœæœªçŸ¥ï¼ˆç°åŒºï¼‰
}
```

**æ„ä¹‰**ï¼š
- âœ… æ˜ç¡®è¡¨ç¤º"äº¤æ˜“å¯èƒ½å·²æäº¤ä½†æœ¬åœ°æ— æ³•ç¡®å®š"çš„çŠ¶æ€
- âœ… ä¸ä¼šè¯¯åˆ¤ä¸ºå¤±è´¥å¯¼è‡´ nonce è¢«é”™è¯¯å›æ”¶
- âœ… å¯ä»¥é€šè¿‡åå°è¡¥å¿æœºåˆ¶é€æ­¥è§£å†³

---

### 2. ç»†åŒ–å¼‚å¸¸ç±»å‹ä½“ç³»

```mermaid
graph TB
    A[ChainException] --> B[KnownTransactionException]
    A --> C[NonceTooLowException]
    A --> D[SubmissionRejectedExc]
    A --> E[TransientChainException]
    
    B --> B1[isPossiblySubmitted = true]
    C --> C1[isPossiblySubmitted = true]
    D --> D1[isPossiblySubmitted = false]
    E --> E1[isPossiblySubmitted = true]
    
    D --> D2[RejectionReason]
    D2 --> D3[INVALID_INPUT]
    D2 --> D4[INSUFFICIENT_FUNDS]
    D2 --> D5[REVERT]
    D2 --> D6[GAS_TOO_LOW]
    
    style B fill:#fff9c4
    style C fill:#fff9c4
    style D fill:#ffccbc
    style E fill:#b3e5fc
```

**å…³é”®è®¾è®¡**ï¼š
- `isPossiblySubmitted()` æ–¹æ³•ï¼šåˆ¤æ–­è¯¥å¼‚å¸¸æ˜¯å¦è¡¨ç¤º"å¯èƒ½å·²æäº¤"
- åªæœ‰ `SubmissionRejectedExc` è¿”å› falseï¼ˆç¡®å®šæœªæäº¤ï¼Œå¯å›æ”¶ nonceï¼‰
- å…¶ä»–å¼‚å¸¸éƒ½è¿”å› trueï¼ˆä¿å®ˆå¤„ç†ï¼Œä¸å›æ”¶ nonceï¼‰

---

### 3. å®Œæ•´çš„å†³ç­–æ ‘

```mermaid
flowchart TD
    A[è°ƒç”¨ chainClient.sendTransaction] --> B{è¿”å›ç»“æœ}
    
    B -->|æˆåŠŸè¿”å› txHash| C[æ˜ç¡®æˆåŠŸ]
    B -->|KnownTransaction/NonceTooLow| D{æœ¬åœ°æ˜¯å¦æœ‰ txHash?}
    B -->|SubmissionRejected| E[ç¡®å®šæ€§å¤±è´¥]
    B -->|ç½‘ç»œ/è¶…æ—¶å¼‚å¸¸| F[ä¸´æ—¶é”™è¯¯]
    
    C --> C1[çŠ¶æ€ = TRACKING]
    C1 --> C2[è¿”å› SUCCESS]
    
    D -->|æœ‰| G[å¹‚ç­‰æˆåŠŸ]
    D -->|æ— | H{èƒ½å¦é‡ç®— hash?}
    
    G --> G1[è¿”å› IDEMPOTENT]
    
    H -->|èƒ½| I[é‡ç®—æˆåŠŸ]
    H -->|ä¸èƒ½| J[è¿›å…¥ç°åŒº]
    
    I --> I1[çŠ¶æ€ = TRACKING]
    I1 --> I2[è¿”å› RESOLVED_GRAY_ZONE]
    
    J --> J1[çŠ¶æ€ = UNKNOWN_SUBMIT_RESULT]
    J1 --> J2[è§¦å‘å‘Šè­¦]
    J2 --> J3[è¿”å› GRAY_ZONE]
    J3 --> J4[ç­‰å¾…åå°è¡¥å¿]
    
    E --> E1[çŠ¶æ€ = FAILED]
    E1 --> E2[å›æ”¶ nonce]
    E2 --> E3[è¿”å› REJECTED]
    
    F --> F1[ä¿æŒ PENDING]
    F1 --> F2[è¿”å› TRANSIENT_ERROR]
    F2 --> F3[ç­‰å¾…ä¸Šå±‚é‡è¯•]
    
    style C fill:#c8e6c9
    style G fill:#c8e6c9
    style I fill:#c8e6c9
    style J fill:#ffccbc
    style E fill:#ffe1e1
    style F fill:#fff9c4
```

---

### 4. ç°åŒºè¡¥å¿æœºåˆ¶

#### å·¥ä½œæµç¨‹

```mermaid
sequenceDiagram
    participant Timer as å®šæ—¶ä»»åŠ¡
    participant Service as GrayZoneReconciliationService
    participant Chain as ChainClient
    participant DB as TxRepository
    
    Timer->>Service: æ¯åˆ†é’Ÿè§¦å‘
    Service->>DB: æŸ¥è¯¢ UNKNOWN_SUBMIT_RESULT äº¤æ˜“
    
    loop å¯¹æ¯ç¬”ç°åŒºäº¤æ˜“
        Service->>Chain: æŸ¥è¯¢é“¾ä¸Šå½“å‰ nonce
        
        alt nonce å·²è¢«æ¶ˆè´¹
            Service->>Chain: å°è¯•æ‰¾åˆ° txHash
            
            alt æ‰¾åˆ°äº† txHash
                Service->>DB: æ›´æ–°çŠ¶æ€ä¸º TRACKING
                Service-->>Service: ç¦»å¼€ç°åŒº âœ…
            else æ‰¾ä¸åˆ° txHash
                Service->>DB: æ ‡è®° FAILEDï¼ˆå¤–éƒ¨æ¶ˆè´¹ï¼‰
                Service-->>Service: ç¦»å¼€ç°åŒºä½†å¤±è´¥ âŒ
            end
            
        else nonce æœªè¢«æ¶ˆè´¹
            Service->>Service: æ£€æŸ¥ç°åŒºåœç•™æ—¶é—´
            
            alt è¶…æ—¶
                Service->>DB: æ ‡è®° FAILED
                Service->>DB: å›æ”¶ nonce
                Service-->>Service: è¶…æ—¶ç¦»å¼€ç°åŒº â±ï¸
            else æœªè¶…æ—¶
                Service-->>Service: ç»§ç»­ç­‰å¾… â³
            end
        end
    end
```

#### è¡¥å¿ç­–ç•¥

| æƒ…å†µ | é“¾ä¸Š nonce | é“¾ä¸Šæ˜¯å¦æœ‰è¯¥ tx | å¤„ç†ç­–ç•¥ | æœ€ç»ˆçŠ¶æ€ |
|------|-----------|---------------|---------|---------|
| A | > æœ¬åœ° nonce | æ‰¾åˆ°äº† txHash | æ›´æ–° txHashï¼ŒçŠ¶æ€æ”¹ä¸º TRACKING | âœ… ç¦»å¼€ç°åŒº |
| B | > æœ¬åœ° nonce | æ‰¾ä¸åˆ° txHash | æ ‡è®° FAILEDï¼ˆå¤–éƒ¨æ¶ˆè´¹ï¼‰ | âŒ ç¦»å¼€ç°åŒºä½†å¤±è´¥ |
| C | = æœ¬åœ° nonce | - | æ£€æŸ¥åœç•™æ—¶é—´ | - |
| C1 | = æœ¬åœ° nonce | - | æœªè¶…æ—¶ï¼Œç»§ç»­ç­‰å¾… | â³ ä¿æŒç°åŒº |
| C2 | = æœ¬åœ° nonce | - | è¶…æ—¶ï¼Œæ ‡è®° FAILED å¹¶å›æ”¶ | â±ï¸ ç¦»å¼€ç°åŒº |

---

### 5. å…³é”®ä»£ç ç‰‡æ®µå¯¹æ¯”

#### V1ï¼ˆåŸæ–¹æ¡ˆï¼‰ï¼šç®€å•å¤„ç†

```java
catch (KnownTransactionException e) {
    if (tx.getTxHash() != null) {
        // å¹‚ç­‰
        return success(tx.getTxHash());
    } else {
        // ç°åŒºï¼šå°è¯•é‡ç®—
        String hash = recompute();
        if (hash != null) {
            return success(hash);
        } else {
            throw new NonceException("æ— æ³•ç¡®å®š hash", e); // âŒ ç›´æ¥å¤±è´¥
        }
    }
}
```

**é—®é¢˜**ï¼šæ— æ³•åŒºåˆ†"ç¡®å®šå¤±è´¥"å’Œ"çŠ¶æ€æœªçŸ¥"ï¼Œç°åŒºç›´æ¥æŠ›å¼‚å¸¸

---

#### V2ï¼ˆä¼˜åŒ–åï¼‰ï¼šç»†åŒ–å¤„ç†

```java
catch (KnownTransactionException | NonceTooLowException e) {
    // æƒ…å†µ Aï¼šæœ¬åœ°æœ‰ hash â†’ å¹‚ç­‰æˆåŠŸ
    if (tx.getTxHash() != null) {
        return SubmissionResult.idempotent(tx.getTxHash());
    }
    
    // æƒ…å†µ Bï¼šæœ¬åœ°æ—  hash â†’ ç°åŒº
    String recomputedHash = chainClient.computeTransactionHash(request);
    
    if (recomputedHash != null) {
        // B1ï¼šé‡ç®—æˆåŠŸ â†’ ç¦»å¼€ç°åŒº
        tx.setTxHash(recomputedHash);
        tx.setState(TransactionState.TRACKING);
        return SubmissionResult.resolvedFromGrayZone(recomputedHash);
        
    } else {
        // B2ï¼šé‡ç®—å¤±è´¥ â†’ è¿›å…¥ç°åŒºçŠ¶æ€
        tx.setState(TransactionState.UNKNOWN_SUBMIT_RESULT);
        tx.setErrorReason("Gray zone: known tx but no local hash");
        
        alertService.sendAlert(...); // âœ… å‘Šè­¦ä½†ä¸å¤±è´¥
        
        return SubmissionResult.grayZone(e.getMessage());
    }
}
```

**æ”¹è¿›**ï¼š
- âœ… è¿›å…¥ä¸“é—¨çš„ç°åŒºçŠ¶æ€ï¼Œè€Œéå¤±è´¥
- âœ… è§¦å‘å‘Šè­¦ï¼Œé€šçŸ¥è¿ç»´
- âœ… ç­‰å¾…åå°è¡¥å¿æœºåˆ¶å¤„ç†

---

### 6. ç›‘æ§æŒ‡æ ‡å¢å¼º

#### æ–°å¢æŒ‡æ ‡

```java
// æˆåŠŸç±»å‹ç»†åˆ†
nonce_submission_success_total{type="direct"}            // ç›´æ¥æˆåŠŸ
nonce_submission_success_total{type="idempotent"}        // å¹‚ç­‰æˆåŠŸ
nonce_submission_success_total{type="resolved_gray"}     // ä»ç°åŒºæ¢å¤

// ç°åŒºç›¸å…³
nonce_gray_zone_entered_total                            // è¿›å…¥ç°åŒºæ¬¡æ•°
nonce_gray_zone_resolved_total{method="found_hash"}      // æ‰¾åˆ° hash ç¦»å¼€
nonce_gray_zone_resolved_total{method="timeout"}         // è¶…æ—¶ç¦»å¼€
nonce_gray_zone_resolved_total{method="external_consumed"} // å¤–éƒ¨æ¶ˆè´¹
nonce_gray_zone_current_count                            // å½“å‰ç°åŒºäº¤æ˜“æ•°

// å¤±è´¥ç±»å‹ç»†åˆ†
nonce_submission_failed_total{reason="insufficient_funds"}
nonce_submission_failed_total{reason="revert"}
nonce_submission_failed_total{reason="gas_too_low"}

// ä¸´æ—¶é”™è¯¯
nonce_submission_transient_error_total
```

#### Grafana é¢æ¿å»ºè®®

```
Panel 1: æäº¤æˆåŠŸç‡
- Query: rate(nonce_submission_success_total[5m]) / rate(nonce_submission_total[5m])
- Alert: < 95%

Panel 2: ç°åŒºäº¤æ˜“è¶‹åŠ¿
- Query: nonce_gray_zone_current_count
- Alert: > 10

Panel 3: ç°åŒºè§£å†³æ–¹å¼åˆ†å¸ƒ
- Query: rate(nonce_gray_zone_resolved_total[1h]) by (method)
- Type: Pie chart

Panel 4: å¤±è´¥åŸå› åˆ†å¸ƒ
- Query: rate(nonce_submission_failed_total[1h]) by (reason)
- Type: Bar chart
```

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

| ç»´åº¦ | V1ï¼ˆåŸæ–¹æ¡ˆï¼‰ | V2ï¼ˆä¼˜åŒ–åï¼‰ | æå‡ |
|------|------------|------------|------|
| **ç°åŒºå¤„ç†** | âŒ ç›´æ¥å¤±è´¥ | âœ… ä¸“é—¨çŠ¶æ€ + è¡¥å¿ | **å…³é”®æ”¹è¿›** |
| **å¼‚å¸¸åˆ†ç±»** | 2 ç§ï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰ | 6 ç§ï¼ˆç²¾ç»†åˆ†ç±»ï¼‰ | **3x ç²¾ç»†åº¦** |
| **ç›‘æ§æŒ‡æ ‡** | åŸºç¡€è®¡æ•° | ç»†åˆ†ç±»å‹ + ç°åŒºæŒ‡æ ‡ | **10+ æ–°æŒ‡æ ‡** |
| **nonce å®‰å…¨** | âš ï¸ å¯èƒ½è¯¯å›æ”¶ | âœ… ä¿å®ˆå¤„ç† | **æ›´å®‰å…¨** |
| **å¯è¿ç»´æ€§** | âš ï¸ éœ€äººå·¥æ’æŸ¥ | âœ… è‡ªåŠ¨è¡¥å¿ + å‘Šè­¦ | **è‡ªåŠ¨åŒ–** |
| **ä»£ç å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | **å¯æ¥å—** |

---

## ğŸš€ å®æ–½å»ºè®®

### é˜¶æ®µ 1ï¼šåŸºç¡€å¼‚å¸¸ä½“ç³»ï¼ˆ1 å¤©ï¼‰

```bash
# åˆ›å»ºå¼‚å¸¸ç±»
src/main/java/com/work/nonce/core/exception/
â”œâ”€â”€ KnownTransactionException.java
â”œâ”€â”€ NonceTooLowException.java
â”œâ”€â”€ SubmissionRejectedExc.java
â””â”€â”€ TransientChainException.java

# æµ‹è¯•
- å•å…ƒæµ‹è¯•ï¼šå¼‚å¸¸æ˜ å°„é€»è¾‘
- é›†æˆæµ‹è¯•ï¼šChainClient çš„é”™è¯¯å¤„ç†
```

---

### é˜¶æ®µ 2ï¼šçŠ¶æ€æšä¸¾ä¸å†³ç­–æ ‘ï¼ˆ1 å¤©ï¼‰

```bash
# ä¿®æ”¹çŠ¶æ€æšä¸¾
src/main/java/com/work/nonce/core/model/
â””â”€â”€ TransactionState.java  # æ–°å¢ UNKNOWN_SUBMIT_RESULT

# å®ç°å†³ç­–æ ‘
src/main/java/com/work/nonce/core/service/
â””â”€â”€ TransactionSubmissionService.java

# æµ‹è¯•
- å•å…ƒæµ‹è¯•ï¼šå„ç§æƒ…å†µçš„å†³ç­–è·¯å¾„
- é›†æˆæµ‹è¯•ï¼šç«¯åˆ°ç«¯æäº¤æµç¨‹
```

---

### é˜¶æ®µ 3ï¼šç°åŒºè¡¥å¿æœºåˆ¶ï¼ˆ2 å¤©ï¼‰

```bash
# å®ç°è¡¥å¿æœåŠ¡
src/main/java/com/work/nonce/core/service/
â””â”€â”€ GrayZoneReconciliationService.java

# é…ç½®
src/main/resources/
â””â”€â”€ application.yml  # æ–°å¢ç°åŒºé…ç½®é¡¹

# æµ‹è¯•
- å•å…ƒæµ‹è¯•ï¼šè¡¥å¿é€»è¾‘å„åˆ†æ”¯
- é›†æˆæµ‹è¯•ï¼šç°åŒºäº¤æ˜“ä»è¿›å…¥åˆ°ç¦»å¼€çš„å®Œæ•´æµç¨‹
- å‹åŠ›æµ‹è¯•ï¼šå¤§é‡ç°åŒºäº¤æ˜“çš„æ€§èƒ½
```

---

### é˜¶æ®µ 4ï¼šç›‘æ§å‘Šè­¦ï¼ˆ1 å¤©ï¼‰

```bash
# å¢åŠ æŒ‡æ ‡
src/main/java/com/work/nonce/core/metrics/
â””â”€â”€ NonceSubmissionMetrics.java

# å‘Šè­¦é…ç½®
monitoring/
â”œâ”€â”€ prometheus-rules.yml
â””â”€â”€ grafana-dashboard.json

# éªŒè¯
- è§¦å‘ç°åŒºæƒ…å†µï¼Œæ£€æŸ¥å‘Šè­¦æ˜¯å¦æ­£å¸¸
- æŸ¥çœ‹ Grafana é¢æ¿æ˜¯å¦æ­£å¸¸å±•ç¤º
```

---

## âœ… éªŒæ”¶æ¸…å•

### åŠŸèƒ½éªŒæ”¶

- [ ] **å¹‚ç­‰åœºæ™¯**ï¼šé‡å¤æäº¤ï¼ˆæœ¬åœ°æœ‰ hashï¼‰è¿”å›æˆåŠŸï¼Œä¸é‡å¤å  nonce
- [ ] **ç°åŒºè¿›å…¥**ï¼šKnownTransaction ä¸”æœ¬åœ°æ—  hashï¼ŒçŠ¶æ€å˜ä¸º UNKNOWN_SUBMIT_RESULT
- [ ] **ç°åŒºç¦»å¼€-æ‰¾åˆ° hash**ï¼šè¡¥å¿æœåŠ¡æ‰¾åˆ° txHashï¼ŒçŠ¶æ€å˜ä¸º TRACKING
- [ ] **ç°åŒºç¦»å¼€-è¶…æ—¶**ï¼šè¶…æ—¶åæ ‡è®° FAILEDï¼Œnonce è¢«å›æ”¶
- [ ] **ç°åŒºç¦»å¼€-å¤–éƒ¨æ¶ˆè´¹**ï¼šnonce è¢«å¤–éƒ¨æ¶ˆè´¹ï¼Œæ ‡è®° FAILED
- [ ] **ç¡®å®šæ€§å¤±è´¥**ï¼šä½™é¢ä¸è¶³/revert ç­‰ï¼Œç«‹å³æ ‡è®° FAILED å¹¶å›æ”¶ nonce
- [ ] **ä¸´æ—¶é”™è¯¯**ï¼šç½‘ç»œè¶…æ—¶ä¿æŒ PENDINGï¼Œå¯é‡è¯•

### æ€§èƒ½éªŒæ”¶

- [ ] ç°åŒºè¡¥å¿ä¸å½±å“æ­£å¸¸æäº¤æ€§èƒ½ï¼ˆ< 5% æ€§èƒ½æŸå¤±ï¼‰
- [ ] è¡¥å¿æ‰«æåœ¨ 1000 ç¬”ç°åŒºäº¤æ˜“ä¸‹å®Œæˆæ—¶é—´ < 10s
- [ ] ç›‘æ§æŒ‡æ ‡é‡‡é›†ä¸å½±å“ååé‡

### ç›‘æ§éªŒæ”¶

- [ ] è¿›å…¥ç°åŒºæ—¶å‘Šè­¦æ­£å¸¸è§¦å‘
- [ ] Prometheus æŒ‡æ ‡æ­£ç¡®è®°å½•å„ç§æƒ…å†µ
- [ ] Grafana é¢æ¿æ­£å¸¸å±•ç¤ºç°åŒºè¶‹åŠ¿
- [ ] ç°åŒºäº¤æ˜“æ•°é‡å¼‚å¸¸æ—¶å‘Šè­¦

---

## ğŸ“ å…³é”®è®¾è®¡åŸåˆ™

### 1. ä¿å®ˆåŸåˆ™

```
å®å¯è¿›å…¥ç°åŒºç­‰å¾…è¡¥å¿ï¼Œä¹Ÿä¸è¯¯åˆ¤å¤±è´¥å¯¼è‡´ nonce è¢«é”™è¯¯å›æ”¶
```

**ç†ç”±**ï¼š
- é”™è¯¯å›æ”¶ nonce â†’ å¯èƒ½é‡å¤ä½¿ç”¨ â†’ **é“¾ä¸Šå†²çª**ï¼ˆä¸¥é‡ï¼‰
- è¿›å…¥ç°åŒº â†’ æœ€å¤šå»¶è¿Ÿç¡®è®¤ â†’ **å¯æ¥å—**

---

### 2. è¡¥å¿ä¼˜äºé¢„é˜²

```
æ— æ³• 100% é¿å…ç°åŒºï¼Œä½†å¯ä»¥ 100% è¡¥å¿ç°åŒº
```

**ç­–ç•¥**ï¼š
- æäº¤æ—¶å°½åŠ›é‡ç®— hashï¼ˆé¢„é˜²ï¼‰
- é‡ç®—å¤±è´¥è¿›å…¥ç°åŒºï¼ˆæ¥å—ï¼‰
- åå°å®šæœŸè¡¥å¿ï¼ˆè§£å†³ï¼‰

---

### 3. å¯è§‚æµ‹æ€§ä¼˜å…ˆ

```
æ¯ä¸ªçŠ¶æ€è½¬æ¢éƒ½è¦æœ‰æŒ‡æ ‡ã€æ—¥å¿—ã€å‘Šè­¦
```

**å®ç°**ï¼š
- æŒ‡æ ‡ï¼šç»†åˆ†ç±»å‹ï¼ˆæˆåŠŸ/å¹‚ç­‰/ç°åŒº/å¤±è´¥ï¼‰
- æ—¥å¿—ï¼šå…³é”®è·¯å¾„ INFOï¼Œå¼‚å¸¸ WARN/ERROR
- å‘Šè­¦ï¼šç°åŒºè¿›å…¥ã€è¶…æ—¶ã€å¤–éƒ¨æ¶ˆè´¹

---

## ğŸ“š å‚è€ƒèµ„æ–™

### FireFly ç›¸å…³å®ç°

- [submission_error.go](https://github.com/hyperledger/firefly-transaction-manager/blob/main/pkg/ffcapi/submission_error.go)
  - `MapSubmissionRejected()` åŒºåˆ†ç¡®å®šæ€§å¤±è´¥
  - `ErrorKnownTransaction / ErrorReasonNonceTooLow` çš„å¹‚ç­‰å¤„ç†

### ç›¸å…³è®ºæ–‡

- [Idempotence in Distributed Systems](https://www.microsoft.com/en-us/research/publication/idempotence-is-not-a-medical-condition/)
- [Handling Network Partitions](https://aphyr.com/posts/281-call-me-maybe-carly-rae-jepsen-and-the-perils-of-network-partitions)

---

## ğŸ‰ æ€»ç»“

é€šè¿‡å¼•å…¥ **UNKNOWN_SUBMIT_RESULT çŠ¶æ€ + ç»†åŒ–å¼‚å¸¸ä½“ç³» + ç°åŒºè¡¥å¿æœºåˆ¶**ï¼Œæˆ‘ä»¬å°†åŸæœ¬"ç®€å•ä½†ä¸å®‰å…¨"çš„äºŒåˆ†æ³•å‡çº§ä¸º"ç²¾ç»†ä¸”å¯è¡¥å¿"çš„å¤šçŠ¶æ€ç®¡ç†ã€‚

**æ ¸å¿ƒä»·å€¼**ï¼š
1. âœ… **æ›´å®‰å…¨**ï¼šä¸ä¼šè¯¯å›æ”¶ nonce
2. âœ… **æ›´æ™ºèƒ½**ï¼šè‡ªåŠ¨è¡¥å¿ç°åŒºäº¤æ˜“
3. âœ… **æ›´å¯è§‚æµ‹**ï¼šç»†åˆ†æŒ‡æ ‡å’Œå‘Šè­¦
4. âœ… **æ›´åŠ¡å®**ï¼šæ‰¿è®¤ç°åŒºçš„å­˜åœ¨ï¼Œä¸»åŠ¨åº”å¯¹

è¿™æ­£æ˜¯ **FireFly æ–¹æ³•è®ºåœ¨ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ**ã€‚ğŸš€

