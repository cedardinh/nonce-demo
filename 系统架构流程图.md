# Nonce管理系统 - 业务架构流程图

## 一、核心业务流程总览

```mermaid
graph TB
    Start([业务请求]) --> Facade[Nonce门面层<br/>统一业务入口]
    
    Facade --> Template{执行模板<br/>withNonce}
    
    Template --> Allocate[分配Nonce]
    Allocate --> Handler[执行业务逻辑<br/>链上交易]
    
    Handler --> Success{业务结果}
    Success -->|成功| MarkUsed[标记已使用<br/>USED状态]
    Success -->|失败| MarkRecyclable[标记可回收<br/>RECYCLABLE状态]
    
    MarkUsed --> End1([返回结果])
    MarkRecyclable --> End2([返回结果])
    
    Handler -->|异常| AutoRecycle[自动回收Nonce<br/>防止资源泄漏]
    AutoRecycle --> End3([异常返回])
    
    style Facade fill:#e1f5ff
    style Template fill:#fff4e1
    style Allocate fill:#e8f5e9
    style Handler fill:#fce4ec
    style MarkUsed fill:#c8e6c9
    style MarkRecyclable fill:#ffccbc
```

## 二、Nonce分配引擎路由机制

```mermaid
graph TB
    Request[业务请求] --> Manager[引擎管理器<br/>智能路由]
    
    Manager --> CheckMode{当前运行模式}
    
    CheckMode -->|可靠模式| Reliable[可靠引擎<br/>数据库串行分配]
    CheckMode -->|性能模式| Performance[性能引擎<br/>Redis快速分配]
    CheckMode -->|双写模式| DualWrite[双写引擎<br/>数据库+Redis镜像]
    CheckMode -->|降级模式| Degraded[降级引擎<br/>自动回退到可靠模式]
    CheckMode -->|排水模式| Drain[排水引擎<br/>等待队列清空]
    
    Reliable --> DB[(PostgreSQL数据库)]
    Performance --> Redis[(Redis缓存)]
    Performance --> Queue[异步刷盘队列]
    Queue --> DB
    
    DualWrite --> DB
    DualWrite --> Redis
    
    Degraded --> Reliable
    Drain --> Reliable
    
    style Manager fill:#e1f5ff
    style Reliable fill:#c8e6c9
    style Performance fill:#fff4e1
    style DualWrite fill:#e8f5e9
    style Degraded fill:#ffccbc
    style Drain fill:#f3e5f5
```

## 三、可靠模式详细流程

```mermaid
graph TB
    Start([分配请求]) --> Lock[获取Submitter锁<br/>防止并发冲突]
    
    Lock --> LoadState[锁定并加载状态<br/>SELECT FOR UPDATE]
    
    LoadState --> SyncChain[同步链上状态<br/>确认已使用的Nonce]
    
    SyncChain --> CheckRecycle{查找可复用Nonce<br/>RECYCLABLE状态}
    
    CheckRecycle -->|找到| Reuse[复用旧Nonce<br/>优先使用最小号]
    CheckRecycle -->|未找到| Generate[生成新Nonce<br/>nextLocalNonce自增]
    
    Reuse --> Reserve[标记为RESERVED<br/>写入数据库]
    Generate --> Reserve
    
    Reserve --> ReleaseLock[释放锁]
    ReleaseLock --> Return([返回Nonce给业务])
    
    style Lock fill:#e1f5ff
    style LoadState fill:#fff4e1
    style SyncChain fill:#e8f5e9
    style Reuse fill:#c8e6c9
    style Generate fill:#fce4ec
    style Reserve fill:#fff9c4
```

## 四、性能模式详细流程

```mermaid
graph TB
    Start([分配请求]) --> Lock[获取Submitter锁]
    
    Lock --> CheckPool{检查回收池<br/>Redis ZSet}
    
    CheckPool -->|有可复用| PopRecycle[弹出最小Nonce<br/>优先复用]
    CheckPool -->|无可用| Increment[Redis计数器自增<br/>生成新Nonce]
    
    PopRecycle --> Cache[写入Redis快照<br/>记录分配信息]
    Increment --> Cache
    
    Cache --> Publish[发布刷盘事件<br/>加入异步队列]
    
    Publish --> ReleaseLock[释放锁]
    ReleaseLock --> Return([立即返回Nonce<br/>低延迟响应])
    
    Publish -.异步.-> Worker[刷盘工作线程<br/>定时批量处理]
    Worker --> Batch[批量拉取事件<br/>主队列→待处理队列]
    Batch --> Transaction[数据库事务写入<br/>保证一致性]
    Transaction --> ACK[确认处理完成<br/>从待处理队列删除]
    
    Transaction -->|失败| NACK[重新入队<br/>支持重试]
    
    style Lock fill:#e1f5ff
    style CheckPool fill:#fff4e1
    style Cache fill:#e8f5e9
    style Publish fill:#fce4ec
    style Worker fill:#fff9c4
    style Transaction fill:#c8e6c9
```

## 五、Nonce状态流转机制

```mermaid
stateDiagram-v2
    [*] --> RESERVED: 分配Nonce
    
    RESERVED --> USED: 业务成功<br/>链上交易确认
    RESERVED --> RECYCLABLE: 业务失败<br/>超时或放弃
    
    RECYCLABLE --> RESERVED: 复用Nonce<br/>重新分配
    
    USED --> [*]: 永久占用<br/>不再复用
    
    note right of RESERVED
        已分配给业务
        等待链上确认
        有超时保护机制
    end note
    
    note right of USED
        链上交易已确认
        永久占用
        记录交易哈希
    end note
    
    note right of RECYCLABLE
        可重新分配
        优先复用
        记录回收原因
    end note
```

## 六、模式切换流程

```mermaid
graph TB
    Start([系统启动]) --> Init[初始化: 可靠模式<br/>所有流量走数据库]
    
    Init --> Warmup{需要性能优化?}
    
    Warmup -->|是| DualWrite[切换到双写模式<br/>数据库+Redis镜像]
    Warmup -->|否| StayReliable[保持可靠模式]
    
    DualWrite --> Verify{验证Redis同步<br/>队列是否清空}
    
    Verify -->|通过| Performance[切换到性能模式<br/>Redis为主流程]
    Verify -->|失败| StayDual[保持双写模式]
    
    Performance --> Monitor[持续监控<br/>健康度检查]
    
    Monitor --> Healthy{性能链路健康?}
    
    Healthy -->|是| StayPerformance[保持性能模式]
    Healthy -->|否| AutoDegrade[自动降级<br/>回退到可靠模式]
    
    Performance --> ManualDrain{需要维护?}
    ManualDrain -->|是| Drain[排水模式<br/>等待队列清空]
    Drain --> Reliable[切换回可靠模式]
    
    StayReliable --> End([运行中])
    StayPerformance --> End
    AutoDegrade --> End
    Reliable --> End
    
    style Init fill:#c8e6c9
    style DualWrite fill:#fff4e1
    style Performance fill:#e1f5ff
    style AutoDegrade fill:#ffccbc
    style Drain fill:#f3e5f5
```

## 七、完整业务场景流程

```mermaid
sequenceDiagram
    participant 业务方 as 业务系统
    participant 门面 as Nonce门面层
    participant 模板 as 执行模板
    participant 管理器 as 引擎管理器
    participant 引擎 as 分配引擎
    participant Redis as Redis缓存
    participant 数据库 as PostgreSQL
    participant 队列 as 刷盘队列
    participant 工作线程 as 刷盘工作线程
    participant 链上 as 区块链网络
    
    业务方->>门面: 请求分配Nonce
    门面->>模板: withNonce(业务逻辑)
    模板->>管理器: 分配Nonce
    管理器->>引擎: 根据模式路由
    
    alt 性能模式
        引擎->>Redis: 检查回收池/计数器
        Redis-->>引擎: 返回Nonce值
        引擎->>Redis: 写入快照缓存
        引擎->>队列: 发布刷盘事件
        引擎-->>管理器: 立即返回Nonce
        管理器-->>模板: 返回Nonce
        模板->>业务方: 执行业务逻辑
        业务方->>链上: 发送交易
        链上-->>业务方: 返回交易哈希
        业务方-->>模板: 返回执行结果
        模板->>引擎: 标记USED/RECYCLABLE
        引擎->>Redis: 更新状态
        引擎->>队列: 发布状态更新事件
        
        工作线程->>队列: 定时批量拉取
        队列-->>工作线程: 返回事件列表
        工作线程->>数据库: 批量事务写入
        数据库-->>工作线程: 写入成功
        工作线程->>队列: 确认处理完成
    else 可靠模式
        引擎->>数据库: 锁定状态行
        数据库-->>引擎: 返回当前状态
        引擎->>数据库: 查找可复用/生成新Nonce
        引擎->>数据库: 标记RESERVED
        数据库-->>引擎: 写入成功
        引擎-->>管理器: 返回Nonce
        管理器-->>模板: 返回Nonce
        模板->>业务方: 执行业务逻辑
        业务方->>链上: 发送交易
        链上-->>业务方: 返回交易哈希
        业务方-->>模板: 返回执行结果
        模板->>引擎: 标记USED/RECYCLABLE
        引擎->>数据库: 更新状态
    end
    
    模板-->>门面: 返回最终结果
    门面-->>业务方: 返回业务结果
```

## 八、异常处理和容错机制

```mermaid
graph TB
    Request[业务请求] --> Try[尝试执行]
    
    Try --> Success{执行成功?}
    
    Success -->|是| Normal[正常返回]
    
    Success -->|否| CheckType{异常类型}
    
    CheckType -->|业务异常| BusinessFail[标记RECYCLABLE<br/>允许重试]
    CheckType -->|超时异常| Timeout[标记RECYCLABLE<br/>防止资源泄漏]
    CheckType -->|系统异常| SystemError[记录错误日志<br/>降级处理]
    
    SystemError --> CheckMode{当前模式}
    
    CheckMode -->|性能模式| RedisFail{Redis异常?}
    RedisFail -->|是| AutoDegrade[自动降级<br/>切换到可靠模式]
    RedisFail -->|否| QueueFail{队列异常?}
    
    QueueFail -->|是| Retry[重试机制<br/>最多3次]
    QueueFail -->|否| Normal
    
    Retry --> RetrySuccess{重试成功?}
    RetrySuccess -->|是| Normal
    RetrySuccess -->|否| Alert[告警通知<br/>人工介入]
    
    AutoDegrade --> Reliable[可靠模式处理]
    Reliable --> Normal
    
    BusinessFail --> Normal
    Timeout --> Normal
    
    style Try fill:#e1f5ff
    style AutoDegrade fill:#ffccbc
    style Retry fill:#fff4e1
    style Alert fill:#fce4ec
```

## 九、数据一致性保障机制

```mermaid
graph TB
    Start([数据操作]) --> Lock[分布式锁<br/>Submitter级别]
    
    Lock --> Mode{运行模式}
    
    Mode -->|可靠模式| DBTransaction[数据库事务<br/>ACID保证]
    Mode -->|性能模式| RedisLock[Redis锁<br/>+异步刷盘]
    
    DBTransaction --> Commit[提交事务]
    Commit --> ReleaseLock1[释放锁]
    
    RedisLock --> RedisWrite[写入Redis<br/>立即返回]
    RedisWrite --> QueueEvent[加入刷盘队列]
    QueueEvent --> ReleaseLock2[释放锁]
    
    QueueEvent -.异步.-> BatchProcess[批量处理]
    BatchProcess --> DBTransaction2[数据库事务写入<br/>保证最终一致性]
    
    DBTransaction2 --> Success{写入成功?}
    Success -->|是| ACK[确认处理]
    Success -->|否| Retry[重试机制]
    
    Retry --> DBTransaction2
    
    ReleaseLock1 --> End([完成])
    ReleaseLock2 --> End
    ACK --> End
    
    note1[可靠模式:<br/>强一致性<br/>同步写入数据库]
    note2[性能模式:<br/>最终一致性<br/>Redis快速响应+异步刷盘]
    
    style Lock fill:#e1f5ff
    style DBTransaction fill:#c8e6c9
    style RedisWrite fill:#fff4e1
    style BatchProcess fill:#e8f5e9
```

## 十、系统监控和健康检查

```mermaid
graph TB
    Monitor[监控系统] --> HealthCheck[健康检查]
    
    HealthCheck --> CheckRedis{Redis健康?}
    HealthCheck --> CheckQueue{队列积压?}
    HealthCheck --> CheckFlush{刷盘成功率?}
    HealthCheck --> CheckDB{数据库连接?}
    
    CheckRedis -->|异常| RedisAlert[Redis告警<br/>触发降级]
    CheckRedis -->|正常| Next1[继续检查]
    
    CheckQueue -->|积压过多| QueueAlert[队列告警<br/>触发同步写]
    CheckQueue -->|正常| Next2[继续检查]
    
    CheckFlush -->|失败率高| FlushAlert[刷盘告警<br/>检查重试]
    CheckFlush -->|正常| Next3[继续检查]
    
    CheckDB -->|异常| DBAlert[数据库告警<br/>系统不可用]
    CheckDB -->|正常| AllHealthy[系统健康]
    
    RedisAlert --> Degrade[自动降级]
    QueueAlert --> SyncWrite[同步写兜底]
    FlushAlert --> Retry[重试机制]
    DBAlert --> Stop[停止服务]
    
    AllHealthy --> Metrics[记录指标<br/>响应时间/成功率/吞吐量]
    
    style HealthCheck fill:#e1f5ff
    style RedisAlert fill:#ffccbc
    style QueueAlert fill:#fff4e1
    style FlushAlert fill:#fce4ec
    style AllHealthy fill:#c8e6c9
```

---

## 关键设计要点总结

### 1. **双模式设计**
- **可靠模式**：强一致性，适合对数据准确性要求极高的场景
- **性能模式**：高吞吐量，适合高频交易场景，通过异步刷盘保证最终一致性

### 2. **智能路由**
- 引擎管理器根据配置和健康状态自动选择最优模式
- 支持平滑切换，不影响业务连续性

### 3. **状态管理**
- RESERVED：已分配，等待业务确认
- USED：已使用，永久占用
- RECYCLABLE：可回收，优先复用

### 4. **容错机制**
- 分布式锁防止并发冲突
- 自动降级保证服务可用性
- 重试机制保证数据最终一致性

### 5. **性能优化**
- Redis缓存加速分配
- 异步批量刷盘减少数据库压力
- 优先复用可回收Nonce，减少浪费

