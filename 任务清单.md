# Nonce 管理系统演进任务清单

> 快速任务跟踪表，详细说明见《项目演进计划.md》

---

## 阶段 1：基础设施增强（分布式协调能力）

| 任务ID | 任务名称 | 优先级 | 工作量 | 状态 | 负责人 | 备注 |
|--------|---------|--------|--------|------|--------|------|
| 1.1 | 实现 Signer 租约表与管理器 | P0 | 2-3天 | ⬜️ 待开始 | | 建立"同一时刻只有一个节点拥有该 signer 执行权"的机制 |
| 1.2 | 为 Nonce 分配添加 Fencing Token 校验 | P0 | 3-4天 | ⬜️ 待开始 | | 所有写入必须带 fencing_token，拒绝旧 token |
| 1.3 | 实现基于一致性哈希的路由层 | P1 | 2-3天 | ⬜️ 待开始 | | 性能优化，可选 |

**阶段 1 里程碑**：能够在多节点环境下安全分配 nonce，防止脑裂

---

## 阶段 2：Nonce 分配增强（对齐链上 + 缓存）

| 任务ID | 任务名称 | 优先级 | 工作量 | 状态 | 负责人 | 备注 |
|--------|---------|--------|--------|------|--------|------|
| 2.1 | 实现链上 Nonce 查询接口 | P0 | 2天 | ⬜️ 待开始 | | 能够从区块链查询 signer 的最新 nonce |
| 2.2 | 实现三级决策 max(chain, cache, db) | P0 | 3-4天 | ⬜️ 待开始 | | 分配时综合三个来源，取最大值 |
| 2.3 | 实现 Batch Writer 模式 | P1 | 4-5天 | ⬜️ 待开始 | | 批量处理，性能优化 |

**阶段 2 里程碑**：Nonce 分配与链上保持一致，性能提升 3-5 倍

---

## 阶段 3：终局确认系统（Receipt + Confirmations + Reorg）

| 任务ID | 任务名称 | 优先级 | 工作量 | 状态 | 负责人 | 备注 |
|--------|---------|--------|--------|------|--------|------|
| 3.1 | 实现交易记录表（ManagedTransaction） | P0 | 5-7天 | ⬜️ 待开始 | | 交易记录作为 nonce 的事实载体 |
| 3.2 | 实现 Receipt Checker（异步拉取） | P0 | 3-4天 | ⬜️ 待开始 | | 异步查询交易 receipt |
| 3.3 | 实现确认数管理器（Confirmations） | P0 | 5-7天 | ⬜️ 待开始 | | 计算确认数并判断终局 |
| 3.4 | 实现 Confirmed Block Listener（稳定区块流） | P1 | 3-4天 | ⬜️ 待开始 | | 只输出稳定区块，避免重组影响 |
| 3.5 | 实现 BufferChannel（避免下游阻塞） | P2 | 2-3天 | ⬜️ 待开始 | | 隔离慢消费者 |

**阶段 3 里程碑**：完整的终局跟踪系统，从 receipt 到 N 次确认全链路可见

---

## 阶段 4：交易生命周期管理（Resubmit + 超时）

| 任务ID | 任务名称 | 优先级 | 工作量 | 状态 | 负责人 | 备注 |
|--------|---------|--------|--------|------|--------|------|
| 4.1 | 实现 Policy Loop（交易状态巡检） | P0 | 3-4天 | ⬜️ 待开始 | | 定期扫描 Tracking 交易，触发 resubmit |
| 4.2 | 实现 Gas Bump 钩子 | P2 | 2-3天 | ⬜️ 待开始 | | 重提时逐步提高 gas，可选 |

**阶段 4 里程碑**：长期 pending 的交易能自动重提，避免卡死

---

## 阶段 5：幂等性与容错增强

| 任务ID | 任务名称 | 优先级 | 工作量 | 状态 | 负责人 | 备注 |
|--------|---------|--------|--------|------|--------|------|
| 5.1 | 实现 Request ID 去重 | P0 | 2天 | ⬜️ 待开始 | | 避免重复请求消耗多个 nonce |
| 5.2 | 实现"已知交易"错误处理 | P1 | 3天 | ⬜️ 待开始 | | 重复提交时幂等返回成功 |
| 5.3 | 实现状态回写的 Fencing 校验 | P0 | 2天 | ⬜️ 待开始 | | 防止旧节点覆盖新节点写入 |

**阶段 5 里程碑**：系统具备完善的幂等性和容错能力

---

## 阶段 6：监控与运维能力

| 任务ID | 任务名称 | 优先级 | 工作量 | 状态 | 负责人 | 备注 |
|--------|---------|--------|--------|------|--------|------|
| 6.1 | 实现全局监控视图 | P2 | 2-3天 | ⬜️ 待开始 | | 实时查看每个 signer 的 nonce 使用情况 |
| 6.2 | 实现链上对账与自动修复 | P2 | 3-4天 | ⬜️ 待开始 | | 检测本地与链上不一致，自动修复 |
| 6.3 | 实现告警机制 | P2 | 2天 | ⬜️ 待开始 | | 关键异常时触发告警 |

**阶段 6 里程碑**：完善的监控运维体系，可观测、可运维

---

## 总体进度

### 按优先级统计

| 优先级 | 任务数 | 已完成 | 进行中 | 待开始 | 总工作量 |
|--------|--------|--------|--------|--------|----------|
| P0（必须） | 11 | 0 | 0 | 11 | 33-40天 |
| P1（重要） | 5 | 0 | 0 | 5 | 15-19天 |
| P2（次要） | 5 | 0 | 0 | 5 | 11-15天 |
| **合计** | **21** | **0** | **0** | **21** | **59-74天** |

### 按阶段统计

| 阶段 | 任务数 | 已完成 | 进行中 | 待开始 | 预计工作量 |
|------|--------|--------|--------|--------|------------|
| 阶段 1：基础设施增强 | 3 | 0 | 0 | 3 | 7-10天 |
| 阶段 2：Nonce 分配增强 | 3 | 0 | 0 | 3 | 9-11天 |
| 阶段 3：终局确认系统 | 5 | 0 | 0 | 5 | 18-25天 |
| 阶段 4：交易生命周期 | 2 | 0 | 0 | 2 | 5-7天 |
| 阶段 5：幂等性增强 | 3 | 0 | 0 | 3 | 7天 |
| 阶段 6：监控运维 | 3 | 0 | 0 | 3 | 7-9天 |

---

## 迭代计划

### 第一轮迭代（Week 1-3）：分布式协调基础

**目标**：能够在多节点环境下安全分配 nonce，防止脑裂

- [x] 任务 1.1：Signer 租约表与管理器
- [x] 任务 1.2：Fencing Token 校验
- [x] 任务 2.1：链上 Nonce 查询接口
- [x] 任务 2.2：三级决策 max(chain, cache, db)
- [x] 任务 5.1：Request ID 去重

**验收标准**：
- [ ] 多节点并发分配无冲突
- [ ] 节点宕机后 lease 自动转移
- [ ] 脑裂时旧节点写入被拒绝
- [ ] 本地 nonce 与链上保持一致

---

### 第二轮迭代（Week 4-7）：终局跟踪系统

**目标**：完整的交易生命周期管理，从分配到终局全链路可见

- [x] 任务 3.1：ManagedTransaction 表改造
- [x] 任务 3.2：Receipt Checker
- [x] 任务 3.3：确认数管理器
- [x] 任务 4.1：Policy Loop（resubmit）
- [x] 任务 5.3：状态回写 Fencing 校验

**验收标准**：
- [ ] 交易从 Pending → Tracking → Confirmed 全流程可追踪
- [ ] receipt 异步查询不阻塞主路径
- [ ] 达到 N 次确认后自动标记终局
- [ ] 长期 pending 交易自动 resubmit
- [ ] 链重组时确认数正确回退

---

### 第三轮迭代（Week 8-9）：性能优化

**目标**：吞吐量提升 3-5 倍，延迟降低

- [x] 任务 2.3：Batch Writer 模式
- [x] 任务 3.4：Confirmed Block Listener
- [x] 任务 5.2："已知交易"错误处理
- [x] 任务 1.3：一致性哈希路由（可选）

**验收标准**：
- [ ] 吞吐量 > 1000 TPS（单 signer）
- [ ] 分配延迟 P99 < 500ms
- [ ] 批处理命中率 > 80%
- [ ] 路由命中率 > 95%

---

### 第四轮迭代（Week 10-11）：监控运维

**目标**：完善的运维体系，可观测、可运维

- [x] 任务 6.1：全局监控视图
- [x] 任务 6.2：链上对账
- [x] 任务 6.3：告警机制
- [x] 任务 3.5：BufferChannel
- [x] 任务 4.2：Gas Bump 钩子

**验收标准**：
- [ ] Prometheus 指标完整
- [ ] Grafana 面板可用
- [ ] 对账自动运行并修复
- [ ] 告警正确触发

---

## 风险与依赖

### 技术风险

| 风险项 | 影响 | 缓解措施 | 负责人 |
|--------|------|----------|--------|
| Lease 实现复杂度高 | 阻塞阶段 1 | 参考 FireFly 实现，充分测试 | |
| 链重组处理逻辑复杂 | 阻塞阶段 3 | 先实现简单版本，再逐步增强 | |
| 性能优化效果不明显 | 影响阶段 3 | 做好基准测试，对比优化前后 | |

### 外部依赖

| 依赖项 | 类型 | 状态 | 备注 |
|--------|------|------|------|
| Web3j 或区块链 SDK | 技术 | ✅ 可用 | 需要支持查询 nonce、receipt、区块 |
| Redis Cluster | 基础设施 | ✅ 可用 | 用于分布式锁和缓存 |
| PostgreSQL 14+ | 基础设施 | ✅ 可用 | 需要支持 ON CONFLICT、FOR UPDATE |
| Prometheus + Grafana | 运维工具 | ⬜️ 待确认 | 用于监控告警 |

---

## 质量指标

### 测试覆盖率

| 模块 | 目标覆盖率 | 当前覆盖率 | 状态 |
|------|-----------|-----------|------|
| Lease 管理 | > 90% | - | ⬜️ |
| Nonce 分配 | > 90% | - | ⬜️ |
| 状态流转 | > 90% | - | ⬜️ |
| Receipt 查询 | > 80% | - | ⬜️ |
| 确认数计算 | > 85% | - | ⬜️ |

### 性能指标

| 指标 | 目标 | 当前 | 状态 |
|------|------|------|------|
| 吞吐量（单 signer） | > 1000 TPS | - | ⬜️ |
| 分配延迟 P99 | < 500ms | - | ⬜️ |
| 终局延迟（20 次确认） | < 60s | - | ⬜️ |
| 批处理命中率 | > 80% | - | ⬜️ |

---

## 变更日志

| 日期 | 版本 | 变更内容 | 变更人 |
|------|------|----------|--------|
| 2024-12-19 | v1.0 | 初始版本 | - |

---

## 快速命令

```bash
# 查看待开始任务
grep "⬜️ 待开始" 任务清单.md

# 查看 P0 任务
grep "P0" 任务清单.md | grep "待开始"

# 统计任务数量
grep -c "待开始" 任务清单.md
```

---

**说明**：
- ⬜️ 待开始
- 🔄 进行中
- ✅ 已完成
- ❌ 已取消
- ⏸️ 已暂停

