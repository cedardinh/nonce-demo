# Nonce管理系统 - 完整业务架构总览

> 面向产品、开发、测试团队的统一视图

## 系统全景图

```mermaid
graph TB
    subgraph "业务层"
        Business[业务系统<br/>链上交易场景]
    end
    
    subgraph "接口层"
        API[HTTP接口<br/>/api/nonces]
        Facade[Nonce门面<br/>统一入口]
    end
    
    subgraph "执行层"
        Template[执行模板<br/>withNonce方法]
        Processor[结果处理器<br/>自动状态流转]
    end
    
    subgraph "引擎管理层"
        Manager[引擎管理器<br/>智能路由]
    end
    
    subgraph "分配引擎层"
        Reliable[可靠引擎<br/>数据库串行分配]
        Performance[性能引擎<br/>Redis快速分配]
    end
    
    subgraph "存储层"
        Redis[(Redis缓存<br/>计数器/回收池/快照)]
        Queue[(刷盘队列<br/>异步事件)]
        DB[(PostgreSQL<br/>持久化存储)]
    end
    
    subgraph "后台服务"
        Worker[刷盘工作线程<br/>定时批量写入]
        Cleanup[数据清理任务<br/>历史数据归档]
    end
    
    Business -->|业务请求| API
    API --> Facade
    Facade --> Template
    Template --> Manager
    Manager -->|可靠模式| Reliable
    Manager -->|性能模式| Performance
    Reliable --> DB
    Performance --> Redis
    Performance --> Queue
    Queue -.异步.-> Worker
    Worker --> DB
    Template --> Processor
    Processor --> Manager
    Cleanup --> DB
    
    style Business fill:#e3f2fd
    style Facade fill:#fff3e0
    style Manager fill:#e8f5e9
    style Reliable fill:#c8e6c9
    style Performance fill:#fff9c4
    style Redis fill:#ffccbc
    style DB fill:#b2dfdb
```

## 核心业务流程（产品视角）

```mermaid
flowchart TD
    Start([业务方发起交易请求]) --> Step1[1. 申请Nonce号]
    
    Step1 --> Step2{2. 系统分配Nonce}
    
    Step2 -->|可靠模式| Step2A[从数据库查找可复用号<br/>或生成新号]
    Step2 -->|性能模式| Step2B[从Redis快速分配<br/>优先复用旧号]
    
    Step2A --> Step3[3. 返回Nonce给业务]
    Step2B --> Step3
    
    Step3 --> Step4[4. 业务使用Nonce<br/>发送链上交易]
    
    Step4 --> Step5{5. 交易结果}
    
    Step5 -->|成功| Step6A[标记Nonce为已使用<br/>USED状态]
    Step5 -->|失败| Step6B[标记Nonce为可回收<br/>RECYCLABLE状态]
    
    Step6A --> Step7[6. 返回业务结果]
    Step6B --> Step7
    
    Step7 --> End([流程结束])
    
    Step2B -.异步刷盘.-> Step8[后台线程<br/>批量写入数据库]
    Step8 --> DB[(数据库持久化)]
    
    style Start fill:#e3f2fd
    style Step1 fill:#fff3e0
    style Step2 fill:#e8f5e9
    style Step4 fill:#fce4ec
    style Step6A fill:#c8e6c9
    style Step6B fill:#ffccbc
    style Step7 fill:#e1f5ff
```

## Nonce状态生命周期

```mermaid
stateDiagram-v2
    [*] --> 分配中: 业务请求Nonce
    
    分配中 --> RESERVED: 分配成功
    
    RESERVED --> 业务处理中: 返回给业务方
    
    业务处理中 --> USED: 链上交易成功<br/>记录交易哈希
    业务处理中 --> RECYCLABLE: 交易失败/超时<br/>记录失败原因
    
    RECYCLABLE --> RESERVED: 下次分配时<br/>优先复用
    
    USED --> [*]: 永久占用<br/>不再使用
    
    note right of RESERVED
        【已分配状态】
        - 已分配给业务方
        - 等待链上确认
        - 有超时保护（30秒）
    end note
    
    note right of USED
        【已使用状态】
        - 链上交易已确认
        - 永久占用此Nonce
        - 记录交易哈希用于对账
    end note
    
    note right of RECYCLABLE
        【可回收状态】
        - 交易失败或放弃
        - 可以重新分配
        - 优先复用（减少浪费）
    end note
```

## 双模式运行机制

```mermaid
graph LR
    subgraph "可靠模式 - 强一致性"
        R1[业务请求] --> R2[获取锁]
        R2 --> R3[数据库事务]
        R3 --> R4[串行分配]
        R4 --> R5[立即写入DB]
        R5 --> R6[返回结果]
    end
    
    subgraph "性能模式 - 高吞吐"
        P1[业务请求] --> P2[获取锁]
        P2 --> P3[Redis操作]
        P3 --> P4[快速分配]
        P4 --> P5[立即返回]
        P5 --> P6[异步刷盘]
        P6 --> P7[批量写DB]
    end
    
    style R3 fill:#c8e6c9
    style R5 fill:#c8e6c9
    style P3 fill:#fff9c4
    style P5 fill:#fff9c4
    style P7 fill:#b2dfdb
```

## 模式切换策略

```mermaid
graph TB
    Start([系统启动]) --> Reliable[可靠模式<br/>所有流量走数据库]
    
    Reliable -->|需要性能优化| DualWrite[双写模式<br/>数据库+Redis镜像]
    
    DualWrite -->|验证通过| Performance[性能模式<br/>Redis为主流程]
    
    Performance -->|监控健康度| Check{性能链路健康?}
    
    Check -->|健康| Stay[保持性能模式]
    Check -->|异常| Degrade[自动降级<br/>回退可靠模式]
    
    Performance -->|需要维护| Drain[排水模式<br/>等待队列清空]
    Drain --> Reliable
    
    Stay --> Monitor[持续监控]
    Degrade --> Monitor
    Monitor --> Check
    
    style Reliable fill:#c8e6c9
    style DualWrite fill:#fff4e1
    style Performance fill:#fff9c4
    style Degrade fill:#ffccbc
    style Drain fill:#f3e5f5
```

## 异常处理和容错

```mermaid
graph TB
    Request[业务请求] --> Execute[执行分配]
    
    Execute --> Success{执行成功?}
    
    Success -->|是| Return[正常返回]
    
    Success -->|否| Handle{异常处理}
    
    Handle -->|业务失败| Recycle[标记可回收<br/>允许重试]
    Handle -->|超时| Timeout[自动回收<br/>防止泄漏]
    Handle -->|Redis异常| Degrade[自动降级<br/>切换可靠模式]
    Handle -->|数据库异常| Alert[告警通知<br/>系统不可用]
    
    Recycle --> Return
    Timeout --> Return
    Degrade --> Retry[重试分配]
    Retry --> Execute
    
    Alert --> Stop[停止服务]
    
    style Execute fill:#e1f5ff
    style Degrade fill:#ffccbc
    style Recycle fill:#c8e6c9
    style Alert fill:#fce4ec
```

## 数据流转全景

```mermaid
sequenceDiagram
    autonumber
    participant 业务方
    participant 门面层
    participant 执行模板
    participant 引擎管理器
    participant 分配引擎
    participant Redis
    participant 刷盘队列
    participant 数据库
    participant 后台线程
    
    业务方->>门面层: 请求分配Nonce
    门面层->>执行模板: withNonce(业务逻辑)
    执行模板->>引擎管理器: 分配Nonce
    
    alt 性能模式
        引擎管理器->>分配引擎: 性能引擎分配
        分配引擎->>Redis: 检查回收池/计数器
        Redis-->>分配引擎: 返回Nonce值
        分配引擎->>Redis: 写入快照
        分配引擎->>刷盘队列: 发布事件
        分配引擎-->>引擎管理器: 立即返回
    else 可靠模式
        引擎管理器->>分配引擎: 可靠引擎分配
        分配引擎->>数据库: 锁定状态+分配
        数据库-->>分配引擎: 返回Nonce
        分配引擎-->>引擎管理器: 返回
    end
    
    引擎管理器-->>执行模板: 返回Nonce
    执行模板->>业务方: 执行业务逻辑
    业务方->>业务方: 发送链上交易
    业务方-->>执行模板: 返回交易结果
    
    执行模板->>分配引擎: 标记USED/RECYCLABLE
    
    alt 性能模式
        分配引擎->>Redis: 更新状态
        分配引擎->>刷盘队列: 发布更新事件
        后台线程->>刷盘队列: 定时批量拉取
        后台线程->>数据库: 批量事务写入
    else 可靠模式
        分配引擎->>数据库: 直接更新状态
    end
    
    执行模板-->>门面层: 返回结果
    门面层-->>业务方: 返回业务结果
```

## 关键特性总结

### 🎯 产品价值
1. **零冲突保证**：确保链上交易Nonce唯一，避免交易失败
2. **高性能**：支持高并发场景，性能模式可达万级TPS
3. **高可用**：自动降级机制，保证服务连续性
4. **智能复用**：优先复用失败Nonce，减少资源浪费

### 🔧 技术亮点
1. **双模式设计**：可靠模式保证强一致性，性能模式保证高吞吐
2. **智能路由**：根据配置和健康状态自动选择最优模式
3. **平滑切换**：支持模式间无缝切换，不影响业务
4. **最终一致性**：性能模式通过异步刷盘保证数据最终一致

### 🛡️ 安全保障
1. **分布式锁**：Submitter级别锁，防止并发冲突
2. **事务保证**：数据库事务确保ACID特性
3. **超时保护**：RESERVED状态超时自动回收
4. **异常处理**：完善的异常处理和容错机制

### 📊 监控指标
1. **健康度检查**：Redis、队列、刷盘成功率
2. **性能指标**：响应时间、吞吐量、成功率
3. **告警机制**：异常自动告警，支持人工介入

