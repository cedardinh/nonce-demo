## 导读

### 概述

这是一个 nonce 管理组件加一个可运行 demo
我先做了一个最小的 HTTP 接口用来触发业务流程
然后把 nonce 能力封装成 NonceComponent
分配 nonce 时先按 submitter 加锁 再用数据库行锁保证一致性
在事务里回收过期未提交的占用 再优先复用空洞 否则发新号
业务拿到 nonce 后发送交易 得到 txHash
我不再把 txHash 当成链上消耗的证据 而是先标记已提交
后台定时轮询回执 receipt
回执出现后才把 nonce 标记为 USED 并可选把回执落库
最后把配置都放进 application.yml 方便调参

### 项目做事步骤 回忆版

1 启动 Spring Boot 提供一个 POST 接口
2 调用示例业务服务 在 handler 里发送交易并返回 txHash
3 模板先分配 nonce 再执行 handler 再按结果更新状态
4 分配 nonce 时可选 Redis 锁 并在事务结束后释放锁
5 分配事务内锁住 submitter 状态 回收过期占用 选空洞或新号
6 成功提交只标记已提交 绑定 txHash 仍是 RESERVED
7 定时任务扫描已提交记录 查询链上回执
8 回执出现后落库回执 并把 nonce 标记 USED

### 模块速览

- core 门面
  - NonceComponent 业务唯一入口

- core 模板
  - NonceExecutionTemplate 串联 分配 执行 更新

- core 领域服务
  - NonceService 分配与状态变更 全部在事务中

- core 持久化
  - NonceRepository 抽象
  - PostgresNonceRepository MyBatisPlus 实现
  - SubmitterNonceStateMapper 行锁加载状态
  - NonceAllocationMapper 分配回收与查询

- core 锁
  - RedisLockManager 抽象
  - RedisDistributedLockManager 用 Redis setIfAbsent 与 Lua 解锁
  - TransactionLockSynchronizer 事务提交后释放锁

- demo 接口
  - NonceController 提供 POST api
  - NonceDemoService 调用 NonceComponent 并发送交易

- demo 链客户端
  - ChainClient 抽象 发送交易与查询回执
  - MockChainClient 内存实现 延迟生成回执

- demo 后台任务
  - ReceiptPoller 定时轮询回执
  - ReceiptFinalizer 事务内落库回执并 markUsed

### 数据表一眼看懂

- submitter_nonce_state
  - 每个 submitter 一行 记录 nextLocalNonce

- submitter_nonce_allocation
  - 每个 submitter nonce 一行 记录状态与 txHash
  - 状态有 RESERVED USED RECYCLABLE

- tx_receipts 可选
  - 以 txHash 为主键记录 receipt

### 配置一眼看懂

- nonce redis enabled
- nonce lock ttl
- nonce reserved timeout
- nonce degrade on redis failure
- nonce receipt poll interval
- nonce receipt poll batch size


